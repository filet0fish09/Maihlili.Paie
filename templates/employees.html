{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">üë§ Gestion des Employ√©s</h1>
    {% if current_user.is_manager %}
    <button onclick="showAddEmployeeModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
      ‚ûï Ajouter un employ√©
    </button>
    {% endif %}
  </div>

  <div class="space-y-4">
    {% for emp in employees %}
    <div class="bg-white p-4 rounded-lg border border-gray-200 flex items-center justify-between hover:shadow">
      <div class="flex items-center gap-4">
        <div class="text-2xl">üë§</div>
        <div>
          <p class="font-medium text-gray-800">{{ emp.full_name }}</p>
          <p class="text-sm text-gray-500">{{ emp.position or 'Poste non d√©fini' }}</p>
          {% if emp.user %}
          <p class="text-xs text-blue-600">‚úâÔ∏è {{ emp.user.email }}</p>
          {% endif %}
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <span class="px-2 py-1 text-xs rounded-full {% if emp.status == 'active' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
          {% if emp.status == 'active' %}Actif{% else %}Absent{% endif %}
        </span>
        
        {% if current_user.is_manager %}
        <button onclick="editEmployee({{ emp.id }}, '{{ emp.full_name }}', '{{ emp.position or '' }}')" 
                class="text-blue-600 hover:text-blue-800 px-2 py-1 text-sm">
          ‚úèÔ∏è Modifier
        </button>
        <button onclick="deleteEmployee({{ emp.id }})" 
                class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
          üóëÔ∏è Supprimer
        </button>
        {% endif %}
      </div>
    </div>
    {% endfor %}
    
    {% if not employees %}
    <div class="text-center py-12 text-gray-500">
      <div class="text-6xl mb-4">üë§</div>
      <h3 class="text-lg font-medium mb-2">Aucun employ√©</h3>
      <p>Commencez par ajouter des employ√©s √† votre √©quipe</p>
    </div>
    {% endif %}
  </div>
</div>

{% if current_user.is_manager %}
<div id="addEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Ajouter un employ√©</h3>
      <button onclick="hideAddEmployeeModal()" class="text-gray-500 hover:text-gray-700">‚úñÔ∏è</button>
    </div>
    
    <form id="addEmployeeForm" method="POST" class="space-y-4">
      <div>
        <label class="block text-sm font-medium mb-2">Nom complet *</label>
        <input type="text" name="full_name" required
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Poste</label>
        <input type="text" name="position" 
               placeholder="Ex: Technicien, Responsable..."
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Email (optionnel)</label>
        <input type="email" name="email" 
               placeholder="email@example.com"
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="hideAddEmployeeModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
          Ajouter
        </button>
      </div>
    </form>
  </div>
</div>

<div id="editEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Modifier l'employ√©</h3>
      <button onclick="hideEditEmployeeModal()" class="text-gray-500 hover:text-gray-700">‚úñÔ∏è</button>
    </div>
    
    <form id="editEmployeeForm" class="space-y-4">
      <input type="hidden" name="employee_id" id="edit_employee_id">
      
      <div>
        <label class="block text-sm font-medium mb-2">Nom complet *</label>
        <input type="text" name="full_name" id="edit_full_name" required
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Poste</label>
        <input type="text" name="position" id="edit_position"
               placeholder="Ex: Technicien, Responsable..."
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="hideEditEmployeeModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Sauvegarder
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
{% if current_user.is_manager %}
// Fonctions pour les modals
function showAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.remove('hidden');
}

function hideAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.add('hidden');
    document.getElementById('addEmployeeForm').reset();
}

function editEmployee(id, name, position) {
    document.getElementById('edit_employee_id').value = id;
    document.getElementById('edit_full_name').value = name;
    document.getElementById('edit_position').value = position || '';
    document.getElementById('editEmployeeModal').classList.remove('hidden');
}

function hideEditEmployeeModal() {
    document.getElementById('editEmployeeModal').classList.add('hidden');
}

function deleteEmployee(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cet employ√© ?')) {
        fetch(`/api/employees/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

// Gestion du formulaire de modification
document.getElementById('editEmployeeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const employeeId = formData.get('employee_id');
    
    fetch(`/api/employees/${employeeId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideEditEmployeeModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification');

      # models.py - Modifications √† ajouter dans la classe Employee

class Employee(db.Model):
    # ... vos champs existants ...
    
    # NOUVEAUX CHAMPS √Ä AJOUTER
    contract_hours_per_week = db.Column(db.Float, default=35.0)  # Heures contractuelles par semaine
    contract_hours_per_month = db.Column(db.Float, default=151.67)  # Heures contractuelles par mois (35*52/12)
    contract_type = db.Column(db.String(20), default="CDI")  # CDI, CDD, Temps partiel, etc.
    
    # ... vos relations existantes ...

    # NOUVELLES M√âTHODES √Ä AJOUTER
    def get_worked_hours_for_month(self, year=None, month=None):
        """Calcule les heures travaill√©es pour un mois donn√©"""
        from datetime import datetime, timedelta
        import calendar
        
        if not year:
            year = datetime.now().year
        if not month:
            month = datetime.now().month
            
        # Premier et dernier jour du mois
        start_date = datetime(year, month, 1)
        last_day = calendar.monthrange(year, month)[1]
        end_date = datetime(year, month, last_day, 23, 59, 59)
        
        # R√©cup√©rer toutes les assignations du mois
        monthly_assignments = Assignment.query.filter(
            Assignment.employee_id == self.id,
            Assignment.start >= start_date,
            Assignment.start <= end_date,
            Assignment.status.in_(['completed', 'in_progress'])
        ).all()
        
        total_hours = 0
        for assignment in monthly_assignments:
            # Calculer la dur√©e effective
            duration = assignment.end - assignment.start
            total_hours += duration.total_seconds() / 3600
            
        return round(total_hours, 2)

    def get_hours_difference_for_month(self, year=None, month=None):
        """Calcule la diff√©rence entre heures travaill√©es et contractuelles"""
        worked_hours = self.get_worked_hours_for_month(year, month)
        contract_hours = self.contract_hours_per_month
        difference = worked_hours - contract_hours
        
        return {
            'worked_hours': worked_hours,
            'contract_hours': contract_hours,
            'difference': round(difference, 2),
            'percentage': round((worked_hours / contract_hours * 100), 1) if contract_hours > 0 else 0,
            'status': 'over' if difference > 0 else 'under' if difference < 0 else 'exact'
        }

    def get_monthly_hours_history(self, months_count=6):
        """Retourne l'historique des heures sur les derniers mois"""
        from datetime import datetime, timedelta
        import calendar
        
        history = []
        current_date = datetime.now()
        
        for i in range(months_count):
            # Calculer le mois √† analyser
            target_date = current_date.replace(day=1) - timedelta(days=i*30)
            year = target_date.year
            month = target_date.month
            
            month_data = self.get_hours_difference_for_month(year, month)
            month_data['month'] = target_date.strftime('%B %Y')
            month_data['month_short'] = target_date.strftime('%m/%Y')
            
            history.append(month_data)
            
        return list(reversed(history))  # Ordre chronologique

    @property
    def current_month_hours_summary(self):
        """R√©sum√© rapide du mois en cours"""
        return self.get_hours_difference_for_month()

    def update_contract_hours(self, hours_per_week):
        """Met √† jour les heures contractuelles"""
        self.contract_hours_per_week = hours_per_week
        # Calculer les heures mensuelles (moyenne : 52 semaines / 12 mois)
        self.contract_hours_per_month = round(hours_per_week * 52 / 12, 2)

    def __repr__(self):
        return f'<Employee {self.full_name} - {self.contract_hours_per_week}h/sem>'
    });
});
{% endif %}
</script>

{% endblock %}

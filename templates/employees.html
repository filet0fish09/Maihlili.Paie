{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">👤 Gestion des Employés</h1>
      <p class="text-gray-500">Gérez vos équipes et suivez les heures travaillées</p>
    </div>
    {% if current_user.is_manager %}
    <button onclick="showAddEmployeeModal()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
      ➕ Ajouter un employé
    </button>
    {% endif %}
  </div>

  <!-- Statistiques des heures -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employés actifs</p>
          <p class="text-xl font-bold text-gray-800">{{ employees|length }}</p>
        </div>
        <div class="text-3xl text-blue-600">👤</div>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures supplémentaires</p>
          <p class="text-xl font-bold text-orange-600" id="total-over-hours">--</p>
        </div>
        <div class="text-3xl text-orange-600">⏰</div>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures manquantes</p>
          <p class="text-xl font-bold text-red-600" id="total-under-hours">--</p>
        </div>
        <div class="text-3xl text-red-600">⚠️</div>
      </div>
    </div>
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conformité contrats</p>
          <p class="text-xl font-bold text-green-600" id="compliance-rate">--</p>
        </div>
        <div class="text-3xl text-green-600">📊</div>
      </div>
    </div>
  </div>

  <div class="space-y-4">
    {% for emp in employees %}
    <div class="bg-white p-6 rounded-lg border border-gray-200 hover:shadow-md transition-shadow">
      <div class="flex items-center justify-between">
        <!-- Informations employé -->
        <div class="flex items-center gap-4">
          <div class="text-2xl">👤</div>
          <div>
            <p class="font-medium text-gray-800">{{ emp.full_name }}</p>
            <p class="text-sm text-gray-500">{{ emp.position or 'Poste non défini' }}</p>
            <p class="text-xs text-blue-600">{{ emp.contract_type or 'CDI' }} - {{ emp.contract_hours_per_week or 35 }}h/sem</p>
            {% if emp.user %}
            <p class="text-xs text-gray-400">✉️ {{ emp.user.email }}</p>
            {% endif %}
          </div>
        </div>
        
        <!-- Statistiques d'heures du mois en cours -->
        <div class="flex items-center gap-6">
          <!-- Heures travaillées -->
          <div class="text-center">
            <p class="text-lg font-bold text-blue-600">{{ emp.hours_summary.worked_hours }}h</p>
            <p class="text-xs text-gray-500">Travaillées</p>
          </div>
          
          <!-- Heures contractuelles -->
          <div class="text-center">
            <p class="text-lg font-bold text-gray-600">{{ emp.hours_summary.contract_hours }}h</p>
            <p class="text-xs text-gray-500">Contractuelles</p>
          </div>
          
          <!-- Différence -->
          <div class="text-center">
            {% if emp.hours_summary.difference > 0 %}
            <p class="text-lg font-bold text-orange-600">+{{ emp.hours_summary.difference }}h</p>
            <p class="text-xs text-orange-600">Supplémentaires</p>
            {% elif emp.hours_summary.difference < 0 %}
            <p class="text-lg font-bold text-red-600">{{ emp.hours_summary.difference }}h</p>
            <p class="text-xs text-red-600">Manquantes</p>
            {% else %}
            <p class="text-lg font-bold text-green-600">±0h</p>
            <p class="text-xs text-green-600">Conforme</p>
            {% endif %}
          </div>
          
          <!-- Pourcentage -->
          <div class="text-center">
            <p class="text-lg font-bold {% if emp.hours_summary.percentage >= 100 %}text-green-600{% elif emp.hours_summary.percentage >= 90 %}text-yellow-600{% else %}text-red-600{% endif %}">
              {{ emp.hours_summary.percentage }}%
            </p>
            <p class="text-xs text-gray-500">Réalisation</p>
          </div>
        </div>
        
        <!-- Actions -->
        <div class="flex items-center gap-3">
          <span class="px-2 py-1 text-xs rounded-full {% if emp.status == 'active' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
            {% if emp.status == 'active' %}Actif{% else %}Absent{% endif %}
          </span>
          
          {% if current_user.is_manager %}
          <button onclick="viewEmployeeHours({{ emp.id }})" 
                  class="text-blue-600 hover:text-blue-800 px-3 py-2 text-sm rounded-lg hover:bg-blue-50" 
                  title="Voir détails des heures">
            📊 Détails
          </button>
          <button onclick="editEmployeeContract({{ emp.id }}, {{ emp.contract_hours_per_week }}, '{{ emp.contract_type }}')" 
                  class="text-purple-600 hover:text-purple-800 px-3 py-2 text-sm rounded-lg hover:bg-purple-50" 
                  title="Modifier contrat">
            📝 Contrat
          </button>
          <button onclick="editEmployee({{ emp.id }}, '{{ emp.full_name }}', '{{ emp.position or '' }}')" 
                  class="text-green-600 hover:text-green-800 px-2 py-1 text-sm">
            ✏️ Modifier
          </button>
          <button onclick="deleteEmployee({{ emp.id }})" 
                  class="text-red-600 hover:text-red-800 px-2 py-1 text-sm">
            🗑️ Supprimer
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
    
    {% if not employees %}
    <div class="text-center py-12 text-gray-500">
      <div class="text-6xl mb-4">👤</div>
      <h3 class="text-lg font-medium mb-2">Aucun employé</h3>
      <p>Commencez par ajouter des employés à votre équipe</p>
    </div>
    {% endif %}
  </div>
</div>

{% if current_user.is_manager %}
<!-- Modal Ajouter Employé - MODIFIÉ -->
<div id="addEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-lg mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Ajouter un employé</h3>
      <button onclick="hideAddEmployeeModal()" class="text-gray-500 hover:text-gray-700">✖️</button>
    </div>
    
    <form id="addEmployeeForm" method="POST" class="space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="md:col-span-2">
          <label class="block text-sm font-medium mb-2">Nom complet *</label>
          <input type="text" name="full_name" required
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Poste</label>
          <input type="text" name="position" 
                 placeholder="Ex: Technicien, Responsable..."
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Type de contrat</label>
          <select name="contract_type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
            <option value="CDI">CDI</option>
            <option value="CDD">CDD</option>
            <option value="Temps partiel">Temps partiel</option>
            <option value="Stage">Stage</option>
            <option value="Intérim">Intérim</option>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Heures contractuelles/semaine *</label>
          <input type="number" name="contract_hours" step="0.5" min="1" max="50" value="35" required
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Email (optionnel)</label>
          <input type="email" name="email" 
                 placeholder="email@example.com"
                 class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium mb-2">Équipe</label>
          <select name="team_id" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
            <option value="">Aucune équipe</option>
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      
      <div class="flex items-center gap-2 p-3 bg-blue-50 rounded-lg">
        <input type="checkbox" name="create_account" id="create_account" class="rounded">
        <label for="create_account" class="text-sm text-blue-700">Créer un compte utilisateur (requis si email fourni)</label>
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="hideAddEmployeeModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
          Ajouter
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Modifier Contrat - NOUVEAU -->
<div id="editContractModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Modifier le contrat</h3>
      <button onclick="hideEditContractModal()" class="text-gray-500 hover:text-gray-700">✖️</button>
    </div>
    
    <form id="editContractForm" class="space-y-4">
      <input type="hidden" name="employee_id" id="contract_employee_id">
      
      <div>
        <label class="block text-sm font-medium mb-2">Heures contractuelles/semaine *</label>
        <input type="number" name="hours_per_week" id="contract_hours" 
               step="0.5" min="1" max="50" required
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Type de contrat</label>
        <select name="contract_type" id="contract_type" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
          <option value="CDI">CDI</option>
          <option value="CDD">CDD</option>
          <option value="Temps partiel">Temps partiel</option>
          <option value="Stage">Stage</option>
          <option value="Intérim">Intérim</option>
        </select>
      </div>
      
      <div class="p-3 bg-gray-50 rounded-lg text-sm text-gray-600">
        <p><strong>Heures mensuelles calculées :</strong> <span id="monthly_hours">--</span></p>
        <p class="text-xs mt-1">Basé sur 52 semaines / 12 mois</p>
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="hideEditContractModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
          Sauvegarder
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Modifier Employé existant -->
<div id="editEmployeeModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4">
    <div class="flex justify-between items-center mb-4">
      <h3 class="text-lg font-semibold">Modifier l'employé</h3>
      <button onclick="hideEditEmployeeModal()" class="text-gray-500 hover:text-gray-700">✖️</button>
    </div>
    
    <form id="editEmployeeForm" class="space-y-4">
      <input type="hidden" name="employee_id" id="edit_employee_id">
      
      <div>
        <label class="block text-sm font-medium mb-2">Nom complet *</label>
        <input type="text" name="full_name" id="edit_full_name" required
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div>
        <label class="block text-sm font-medium mb-2">Poste</label>
        <input type="text" name="position" id="edit_position"
               placeholder="Ex: Technicien, Responsable..."
               class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
      </div>
      
      <div class="flex gap-3 pt-4">
        <button type="button" onclick="hideEditEmployeeModal()" 
                class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
          Annuler
        </button>
        <button type="submit" 
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
          Sauvegarder
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<script>
// Charger les statistiques au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    loadHoursStats();
});

function loadHoursStats() {
    fetch('/api/hours-stats')
    .then(response => response.json())
    .then(data => {
        if (data.error) return;
        
        document.getElementById('total-over-hours').textContent = data.total_over_hours + 'h';
        document.getElementById('total-under-hours').textContent = data.total_under_hours + 'h';
        
        // Calculer le taux de conformité
        const totalEmployees = data.total_employees;
        const conformEmployees = totalEmployees - data.employees_over - data.employees_under;
        const complianceRate = totalEmployees > 0 ? Math.round((conformEmployees / totalEmployees) * 100) : 0;
        document.getElementById('compliance-rate').textContent = complianceRate + '%';
    })
    .catch(error => {
        console.error('Erreur lors du chargement des stats:', error);
    });
}

{% if current_user.is_manager %}
// Fonctions pour les modals existantes
function showAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.remove('hidden');
}

function hideAddEmployeeModal() {
    document.getElementById('addEmployeeModal').classList.add('hidden');
    document.getElementById('addEmployeeForm').reset();
}

function editEmployee(id, name, position) {
    document.getElementById('edit_employee_id').value = id;
    document.getElementById('edit_full_name').value = name;
    document.getElementById('edit_position').value = position || '';
    document.getElementById('editEmployeeModal').classList.remove('hidden');
}

function hideEditEmployeeModal() {
    document.getElementById('editEmployeeModal').classList.add('hidden');
}

// NOUVELLES FONCTIONS pour le contrat
function editEmployeeContract(employeeId, hoursPerWeek, contractType) {
    document.getElementById('contract_employee_id').value = employeeId;
    document.getElementById('contract_hours').value = hoursPerWeek || 35;
    document.getElementById('contract_type').value = contractType || 'CDI';
    updateMonthlyHours();
    document.getElementById('editContractModal').classList.remove('hidden');
}

function hideEditContractModal() {
    document.getElementById('editContractModal').classList.add('hidden');
}

function updateMonthlyHours() {
    const weeklyHours = parseFloat(document.getElementById('contract_hours').value) || 0;
    const monthlyHours = Math.round((weeklyHours * 52 / 12) * 100) / 100;
    document.getElementById('monthly_hours').textContent = monthlyHours + 'h';
}

function viewEmployeeHours(employeeId) {
    window.location.href = `/employees/${employeeId}/hours`;
}

function deleteEmployee(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cet employé ?')) {
        fetch(`/api/employees/${id}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erreur: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

// Event listeners
document.getElementById('contract_hours').addEventListener('input', updateMonthlyHours);

// Gestion du formulaire de modification d'employé
document.getElementById('editEmployeeForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const employeeId = formData.get('employee_id');
    
    fetch(`/api/employees/${employeeId}`, {
        method: 'PUT',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideEditEmployeeModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification');
    });
});

// Gestion du formulaire de modification de contrat
document.getElementById('editContractForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const employeeId = formData.get('employee_id');
    
    const data = {
        hours_per_week: parseFloat(formData.get('hours_per_week')),
        contract_type: formData.get('contract_type')
    };
    
    fetch(`/api/employees/${employeeId}/contract`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            hideEditContractModal();
            location.reload();
        } else {
            alert('Erreur: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        alert('Erreur lors de la modification du contrat');
    });
});
{% endif %}
</script>
{% endblock %}

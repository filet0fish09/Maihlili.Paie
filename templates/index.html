{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  {% if current_user.is_manager %}
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">üìÖ Planning Maihlili SPV</h1>
    <div class="flex gap-3">
      <button onclick="showQuickAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
        ‚ûï Nouvelle assignation
      </button>
      <a href="{{ url_for('assignments') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        üìã G√©rer les assignations
      </a>
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employ√©s actifs</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_employees }}</p>
        </div>
        <div class="text-4xl text-blue-600">üë§</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Services aujourd'hui</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_shifts_today }}</p>
        </div>
        <div class="text-4xl text-green-600">üóìÔ∏è</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures totales cette semaine</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_hours }}h</p>
        </div>
        <div class="text-4xl text-yellow-600">‚è∞</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conflits d'horaire</p>
          <p class="text-2xl font-bold text-gray-800">{{ conflicts }}</p>
        </div>
        <div class="text-4xl text-red-600">‚ö†Ô∏è</div>
      </div>
    </div>
  </div>

  <div id='calendar-container' class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-screen">
    <div id='calendar'></div>
  </div>

  <div id="quickAddModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Nouvelle assignation</h3>
        <div class="mt-2 px-7 py-3">
          <form id="quickAddForm" method="POST">
            <div class="mb-4">
              <label for="employee_id" class="block text-sm font-medium text-gray-700 text-left">Employ√©</label>
              <select name="employee_id" id="employee_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="">S√©lectionner un employ√©</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="shift_id" class="block text-sm font-medium text-gray-700 text-left">Service</label>
              <select name="shift_id" id="shift_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="">S√©lectionner un service</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="start_date" class="block text-sm font-medium text-gray-700 text-left">Date de d√©but</label>
              <input type="date" name="start_date" id="start_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="start_time" class="block text-sm font-medium text-gray-700 text-left">Heure de d√©but</label>
              <input type="time" name="start_time" id="start_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="end_date" class="block text-sm font-medium text-gray-700 text-left">Date de fin</label>
              <input type="date" name="end_date" id="end_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="end_time" class="block text-sm font-medium text-gray-700 text-left">Heure de fin</label>
              <input type="time" name="end_time" id="end_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="items-center px-4 py-3">
              <button id="closeQuickAddModal" type="button" class="px-4 py-2 bg-gray-300 text-black text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                Annuler
              </button>
              <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Ajouter
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fonctions pour g√©rer le modal d'ajout rapide
        const quickAddModal = document.getElementById('quickAddModal');
        function showQuickAddModal() {
            quickAddModal.classList.remove('hidden');
        }
        function hideQuickAddModal() {
            quickAddModal.classList.add('hidden');
            document.getElementById('quickAddForm').reset();
        }
        document.getElementById('closeQuickAddModal').addEventListener('click', hideQuickAddModal);
        window.onclick = function(event) {
            if (event.target == quickAddModal) {
                hideQuickAddModal();
            }
        }

        // --- CORRECTION : Fonction pour r√©cup√©rer les √©v√©nements ---
        async function getCalendarEvents() {
            const response = await fetch('/api/assignments/events');  // Route corrig√©e
            const events = await response.json();
            return events;
        }

        // Charger les employ√©s et services
        async function loadEmployeesAndShifts() {
            const employeeSelect = document.querySelector('select[name="employee_id"]');
            const shiftSelect = document.querySelector('select[name="shift_id"]');
            
            // Remplir les employ√©s
            employeeSelect.innerHTML = '<option value="">S√©lectionner un employ√©</option>';
            {% for emp in manageable_employees %}
            employeeSelect.innerHTML += '<option value="{{ emp.id }}">{{ emp.full_name }} - {{ emp.position or "Employ√©" }}</option>';
            {% endfor %}
            
            // Remplir les services
            shiftSelect.innerHTML = '<option value="">S√©lectionner un service</option>';
            {% for shift in shifts %}
            shiftSelect.innerHTML += '<option value="{{ shift.id }}" data-color="{{ shift.color }}">{{ shift.name }}</option>';
            {% endfor %}
        }
        
        loadEmployeesAndShifts();

        // Gestion du formulaire d'ajout rapide
        document.getElementById('quickAddForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const startDate = formData.get('start_date');
            const startTime = formData.get('start_time');
            const endDate = formData.get('end_date');
            const endTime = formData.get('end_time');
            
            // Combiner date et heure
            formData.set('start', `${startDate}T${startTime}`);
            formData.set('end', `${endDate}T${endTime}`);
            
            fetch('/api/assignments', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideQuickAddModal();
                    calendar.refetchEvents();
                } else {
                    alert('Erreur: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            });
        });

        // Auto-compl√©ter la date de fin
        document.querySelector('input[name="start_date"]').addEventListener('change', function() {
            const endDateInput = document.querySelector('input[name="end_date"]');
            endDateInput.value = this.value;
        });

        // --- CORRECTION : Configuration FullCalendar avec semaine commen√ßant le lundi ---
        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            firstDay: 1, // AJOUT√â : Commencer la semaine le lundi (0=dimanche, 1=lundi)
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            buttonText: {
                today: 'Aujourd\'hui',
                month: 'Mois',
                week: 'Semaine',
                day: 'Jour'
            },
            navLinks: true,
            dayMaxEvents: true,
            editable: true,
            eventStartEditable: true,
            eventDurationEditable: true,
            // --- AM√âLIORATION : Meilleure lisibilit√© des √©v√©nements ---
            eventDisplay: 'block',
            eventTextColor: '#ffffff',
            eventBorderWidth: 2,
            eventClassNames: function(arg) {
                return ['calendar-event-improved'];
            },
            eventContent: function(arg) {
                // Am√©liorer l'affichage des √©v√©nements
                return {
                    html: `
                        <div class="event-content-improved">
                            <div class="font-semibold text-xs truncate">${arg.event.extendedProps.shift_name}</div>
                            <div class="text-xs opacity-90 truncate">${arg.event.extendedProps.employee_name}</div>
                            <div class="text-xs opacity-75">${arg.event.extendedProps.duration}</div>
                        </div>
                    `
                };
            },
            eventDrop: function(info) {
                updateAssignment(info.event);
            },
            eventResize: function(info) {
                updateAssignment(info.event);
            },
            eventClick: function(info) {
                showAssignmentDetails(info.event);
            },
            events: getCalendarEvents, // Fonction corrig√©e
        });
        
        // --- AJOUT : Styles CSS pour am√©liorer la lisibilit√© ---
        const style = document.createElement('style');
        style.textContent = `
            /* Am√©lioration de la lisibilit√© du calendrier */
            .fc-event {
                border-radius: 6px !important;
                padding: 2px 4px !important;
                margin: 1px 0 !important;
                box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
                border-width: 0 !important;
            }
            
            .event-content-improved {
                line-height: 1.2;
                padding: 1px;
            }
            
            .fc-daygrid-event {
                white-space: normal !important;
                font-size: 11px !important;
            }
            
            .fc-event-title {
                font-weight: 600 !important;
            }
            
            /* Am√©liorer la lisibilit√© du header */
            .fc-toolbar-title {
                font-size: 1.5em !important;
                font-weight: 700 !important;
                color: #374151 !important;
            }
            
            .fc-button {
                background: #4F46E5 !important;
                border-color: #4F46E5 !important;
                font-weight: 500 !important;
            }
            
            .fc-button:hover {
                background: #4338CA !important;
                border-color: #4338CA !important;
            }
            
            .fc-button-primary:disabled {
                background: #9CA3AF !important;
                border-color: #9CA3AF !important;
            }
            
            /* Am√©liorer la lisibilit√© des jours */
            .fc-col-header-cell {
                font-weight: 600 !important;
                background: #F9FAFB !important;
                color: #374151 !important;
                text-transform: uppercase !important;
                font-size: 12px !important;
                letter-spacing: 0.5px !important;
            }
            
            .fc-daygrid-day-number {
                font-weight: 600 !important;
                color: #374151 !important;
            }
            
            .fc-day-today {
                background: #EEF2FF !important;
            }
            
            .fc-day-today .fc-daygrid-day-number {
                background: #4F46E5 !important;
                color: white !important;
                border-radius: 50% !important;
                width: 24px !important;
                height: 24px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                margin: 2px !important;
            }
            
            /* Mode sombre pour le calendrier */
            [data-theme="dark"] .fc {
                --fc-border-color: #374151;
                --fc-button-bg-color: #4F46E5;
                --fc-button-hover-bg-color: #4338CA;
                --fc-today-bg-color: #1E293B;
                background: #1F2937;
                color: #F9FAFB;
            }
            
            [data-theme="dark"] .fc-toolbar-title {
                color: #F9FAFB !important;
            }
            
            [data-theme="dark"] .fc-col-header-cell {
                background: #374151 !important;
                color: #E5E7EB !important;
            }
            
            [data-theme="dark"] .fc-daygrid-day-number {
                color: #E5E7EB !important;
            }
            
            [data-theme="dark"] .fc-day-today {
                background: #1E3A8A !important;
            }
        `;
        document.head.appendChild(style);
        
        calendar.render();

        // Fonction pour mettre √† jour une assignation
        function updateAssignment(event) {
            const eventData = {
                start: event.start.toISOString(),
                end: event.end ? event.end.toISOString() : null
            };
            fetch(`/api/assignments/${event.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Erreur lors de la mise √† jour : ' + data.error);
                    event.revert();
                } else {
                    calendar.refetchEvents();
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
                event.revert();
            });
        }

        // Fonction pour afficher les d√©tails d'une assignation (modal am√©lior√©)
        function showAssignmentDetails(event) {
            const startDate = new Date(event.start);
            const endDate = new Date(event.end);
            
            const detailsHtml = `
                <div class="bg-white rounded-xl p-6 max-w-md mx-auto shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">D√©tails de l'assignation</h3>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700">‚úñÔ∏è</button>
                    </div>
                    
                    <div class="space-y-3 text-sm">
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Service:</span>
                            <span class="font-semibold" style="color: ${event.color};">${event.extendedProps.shift_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Employ√©:</span>
                            <span class="font-semibold text-gray-800">${event.extendedProps.employee_name}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">D√©but:</span>
                            <span class="text-gray-800">${startDate.toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Fin:</span>
                            <span class="text-gray-800">${endDate.toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Dur√©e:</span>
                            <span class="font-semibold text-blue-600">${event.extendedProps.duration}</span>
                        </div>
                        <div class="flex justify-between">
                            <span class="font-medium text-gray-600">Statut:</span>
                            <span class="text-gray-800">${event.extendedProps.status_display}</span>
                        </div>
                        ${event.extendedProps.notes ? `
                        <div class="pt-2 border-t">
                            <span class="font-medium text-gray-600">Notes:</span>
                            <p class="text-gray-700 mt-1">${event.extendedProps.notes}</p>
                        </div>
                        ` : ''}
                        <div class="pt-2 border-t text-xs text-gray-500">
                            Cr√©√© par: ${event.extendedProps.created_by}
                        </div>
                    </div>
                </div>
            `;
            
            // Cr√©er le modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = detailsHtml;
            document.body.appendChild(modal);
            
            // Fermer en cliquant √† l'ext√©rieur
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // Exposer les fonctions globalement
        window.showQuickAddModal = showQuickAddModal;
    });
</script>
{% endblock %}

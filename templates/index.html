{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  {% if current_user.is_manager %}
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">üìÖ Planning Maihlili SPV</h1>
    <div class="flex gap-3">
      <button onclick="showQuickAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
        ‚ûï Nouvelle assignation
      </button>
      <a href="{{ url_for('assignments') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        üìã G√©rer les assignations
      </a>
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employ√©s actifs</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_employees }}</p>
        </div>
        <div class="text-4xl text-blue-600">üë§</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Services aujourd'hui</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_shifts_today }}</p>
        </div>
        <div class="text-4xl text-green-600">üóìÔ∏è</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures totales cette semaine</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_hours }}h</p>
        </div>
        <div class="text-4xl text-yellow-600">‚è∞</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conflits d'horaire</p>
          <p class="text-2xl font-bold text-gray-800">{{ conflicts }}</p>
        </div>
        <div class="text-4xl text-red-600">‚ö†Ô∏è</div>
      </div>
    </div>
  </div>

  <div id='calendar-container' class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 h-screen">
    <div id='calendar'></div>
  </div>

  <div id="quickAddModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Nouvelle assignation</h3>
        <div class="mt-2 px-7 py-3">
          <form id="quickAddForm" method="POST">
            <div class="mb-4">
              <label for="employee_id" class="block text-sm font-medium text-gray-700 text-left">Employ√©</label>
              <select name="employee_id" id="employee_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="">S√©lectionner un employ√©</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="shift_id" class="block text-sm font-medium text-gray-700 text-left">Service</label>
              <select name="shift_id" id="shift_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                <option value="">S√©lectionner un service</option>
              </select>
            </div>
            <div class="mb-4">
              <label for="start_date" class="block text-sm font-medium text-gray-700 text-left">Date de d√©but</label>
              <input type="date" name="start_date" id="start_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="start_time" class="block text-sm font-medium text-gray-700 text-left">Heure de d√©but</label>
              <input type="time" name="start_time" id="start_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="end_date" class="block text-sm font-medium text-gray-700 text-left">Date de fin</label>
              <input type="date" name="end_date" id="end_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="mb-4">
              <label for="end_time" class="block text-sm font-medium text-gray-700 text-left">Heure de fin</label>
              <input type="time" name="end_time" id="end_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div class="items-center px-4 py-3">
              <button id="closeQuickAddModal" type="button" class="px-4 py-2 bg-gray-300 text-black text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                Annuler
              </button>
              <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Ajouter
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

</div>
{% endblock %}

{% block scripts %}
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Fonctions pour g√©rer le modal d'ajout rapide
        const quickAddModal = document.getElementById('quickAddModal');
        function showQuickAddModal() {
            quickAddModal.classList.remove('hidden');
        }
        function hideQuickAddModal() {
            quickAddModal.classList.add('hidden');
            document.getElementById('quickAddForm').reset();
        }
        document.getElementById('closeQuickAddModal').addEventListener('click', hideQuickAddModal);
        window.onclick = function(event) {
            if (event.target == quickAddModal) {
                hideQuickAddModal();
            }
        }

        // --- NOUVEAU CODE AJOUT√â ---
        async function loadEmployeesAndShifts() {
            const employeeSelect = document.querySelector('select[name="employee_id"]');
            const shiftSelect = document.querySelector('select[name="shift_id"]');
            
            // Remplir les employ√©s
            employeeSelect.innerHTML = '<option value="">S√©lectionner un employ√©</option>';
            {% for emp in manageable_employees %}
            employeeSelect.innerHTML += '<option value="{{ emp.id }}">{{ emp.full_name }} - {{ emp.position or "Employ√©" }}</option>';
            {% endfor %}
            
            // Remplir les services
            shiftSelect.innerHTML = '<option value="">S√©lectionner un service</option>';
            {% for shift in shifts %}
            shiftSelect.innerHTML += '<option value="{{ shift.id }}" data-color="{{ shift.color }}">{{ shift.name }}</option>';
            {% endfor %}
        }
        
        // --- NOUVEAU CODE AJOUT√â : Appeler la fonction au chargement du DOM ---
        loadEmployeesAndShifts();

        // Gestion du formulaire d'ajout rapide
        document.getElementById('quickAddForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const startDate = formData.get('start_date');
            const startTime = formData.get('start_time');
            const endDate = formData.get('end_date');
            const endTime = formData.get('end_time');
            
            // Combiner date et heure
            formData.set('start', `${startDate}T${startTime}`);
            formData.set('end', `${endDate}T${endTime}`);
            
            fetch('/api/assignments', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    hideQuickAddModal();
                    calendar.refetchEvents();
                } else {
                    alert('Erreur: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
            });
        });

        // Auto-compl√©ter la date de fin
        document.querySelector('input[name="start_date"]').addEventListener('change', function() {
            const endDateInput = document.querySelector('input[name="end_date"]');
            endDateInput.value = this.value;
        });

        // Fonction pour r√©cup√©rer les √©v√©nements FullCalendar
        async function getCalendarEvents() {
            const response = await fetch('/api/assignments/events');
            const events = await response.json();
            return events;
        }

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'fr',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            navLinks: true,
            dayMaxEvents: true,
            editable: true,
            eventStartEditable: true,
            eventDurationEditable: true,
            eventDrop: function(info) {
                updateAssignment(info.event);
            },
            eventResize: function(info) {
                updateAssignment(info.event);
            },
            eventClick: function(info) {
                showAssignmentDetails(info.event);
            },
            events: getCalendarEvents,
        });
        calendar.render();

        // Fonction pour mettre √† jour une assignation
        function updateAssignment(event) {
            const eventData = {
                start: event.start.toISOString(),
                end: event.end ? event.end.toISOString() : null
            };
            fetch(`/api/assignments/${event.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(eventData)
            })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    alert('Erreur lors de la mise √† jour : ' + data.error);
                    event.revert();
                } else {
                    calendar.refetchEvents();
                }
            })
            .catch(error => {
                console.error('Erreur:', error);
                alert('Erreur de connexion');
                event.revert();
            });
        }

        // Fonction pour afficher les d√©tails d'une assignation (modal)
        function showAssignmentDetails(event) {
            // Logique pour afficher les d√©tails dans un modal
            alert(`
                Assignation : ${event.extendedProps.shift_name}
                Employ√© : ${event.extendedProps.employee_name}
                D√©but : ${event.start.toLocaleString()}
                Fin : ${event.end ? event.end.toLocaleString() : 'N/A'}
                Dur√©e : ${event.extendedProps.duration}
                Statut : ${event.extendedProps.status_display}
                Notes : ${event.extendedProps.notes || 'Aucune'}
                Cr√©√© par : ${event.extendedProps.created_by}
            `);
        }
    });
</script>
{% endblock %}

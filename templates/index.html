{% extends ‚Äúbase.html‚Äù %}
{% block content %}

<div class="space-y-6">
  {% if current_user.is_manager %}
  <div class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-gray-800">üìÖ Planning Maihlili SPV</h1>
    <div class="flex gap-3">
      <button onclick="showQuickAddModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
        ‚ûï Nouvelle assignation
      </button>
      <a href="{{ url_for('assignments') }}" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
        üìã G√©rer les assignations
      </a>
    </div>
  </div>
  {% endif %}

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employ√©s actifs</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_employees }}</p>
        </div>
        <div class="text-4xl text-blue-600">üë§</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Services aujourd'hui</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_shifts_today }}</p>
        </div>
        <div class="text-4xl text-green-600">üóìÔ∏è</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures totales cette semaine</p>
          <p class="text-2xl font-bold text-gray-800">{{ total_hours }}h</p>
        </div>
        <div class="text-4xl text-yellow-600">‚è∞</div>
      </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conflits d'horaire</p>
          <p class="text-2xl font-bold text-gray-800">{{ conflicts }}</p>
        </div>
        <div class="text-4xl text-red-600">‚ö†Ô∏è</div>
      </div>
    </div>
  </div>

  <div id='calendar-container' class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
    <div id='calendar' style="min-height: 600px;"></div>
  </div>

  <!-- Modal ajout rapide -->

{% if current_user.is_manager %}

  <div id="quickAddModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
      <div class="mt-3 text-center">
        <h3 class="text-lg leading-6 font-medium text-gray-900">Nouvelle assignation</h3>
        <div class="mt-2 px-7 py-3">
          <form id="quickAddForm" method="POST">
            <div class="mb-4">
              <label for="employee_id" class="block text-sm font-medium text-gray-700 text-left">Employ√©</label>
              <select name="employee_id" id="employee_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                <option value="">S√©lectionner un employ√©</option>
                {% for emp in manageable_employees %}
                <option value="{{ emp.id }}">{{ emp.full_name }} - {{ emp.position or "Employ√©" }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-4">
              <label for="shift_id" class="block text-sm font-medium text-gray-700 text-left">Service</label>
              <select name="shift_id" id="shift_id" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
                <option value="">S√©lectionner un service</option>
                {% for shift in shifts %}
                <option value="{{ shift.id }}" data-color="{{ shift.color }}">{{ shift.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="mb-4">
              <label for="start_date" class="block text-sm font-medium text-gray-700 text-left">Date de d√©but</label>
              <input type="date" name="start_date" id="start_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <div class="mb-4">
              <label for="start_time" class="block text-sm font-medium text-gray-700 text-left">Heure de d√©but</label>
              <input type="time" name="start_time" id="start_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <div class="mb-4">
              <label for="end_date" class="block text-sm font-medium text-gray-700 text-left">Date de fin</label>
              <input type="date" name="end_date" id="end_date" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <div class="mb-4">
              <label for="end_time" class="block text-sm font-medium text-gray-700 text-left">Heure de fin</label>
              <input type="time" name="end_time" id="end_time" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2 border">
            </div>
            <div class="items-center px-4 py-3">
              <button id="closeQuickAddModal" type="button" class="px-4 py-2 bg-gray-300 text-black text-base font-medium rounded-md w-full shadow-sm hover:bg-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-300">
                Annuler
              </button>
              <button type="submit" class="mt-2 px-4 py-2 bg-blue-600 text-white text-base font-medium rounded-md w-full shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500">
                Ajouter
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded');
    
    // Variables globales
    let calendar;

    // Fonctions pour le modal
    function showQuickAddModal() {
        const modal = document.getElementById('quickAddModal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }

    function hideQuickAddModal() {
        const modal = document.getElementById('quickAddModal');
        if (modal) {
            modal.classList.add('hidden');
            const form = document.getElementById('quickAddForm');
            if (form) form.reset();
        }
    }

    // Event listeners pour le modal
    const closeBtn = document.getElementById('closeQuickAddModal');
    if (closeBtn) {
        closeBtn.addEventListener('click', hideQuickAddModal);
    }

    const modal = document.getElementById('quickAddModal');
    if (modal) {
        modal.addEventListener('click', function(event) {
            if (event.target === modal) {
                hideQuickAddModal();
            }
        });
    }

    // Auto-compl√©ter la date de fin
    const startDateInput = document.getElementById('start_date');
    const endDateInput = document.getElementById('end_date');
    if (startDateInput && endDateInput) {
        startDateInput.addEventListener('change', function() {
            if (!endDateInput.value) {
                endDateInput.value = this.value;
            }
        });
    }

    // Gestion du formulaire d'ajout rapide
    const quickForm = document.getElementById('quickAddForm');
    if (quickForm) {
        quickForm.addEventListener('submit', function(e) {
            e.preventDefault();
            console.log('Form submitted');
            
            const formData = new FormData(this);
            const startDate = formData.get('start_date');
            const startTime = formData.get('start_time');
            const endDate = formData.get('end_date');
            const endTime = formData.get('end_time');
            
            // Combiner date et heure
            formData.set('start', `${startDate}T${startTime}`);
            formData.set('end', `${endDate}T${endTime}`);
            
            fetch('/api/assignments', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response:', data);
                if (data.success) {
                    hideQuickAddModal();
                    if (calendar) {
                        calendar.refetchEvents();
                    } else {
                        location.reload();
                    }
                } else {
                    alert('Erreur: ' + (data.error || 'Erreur inconnue'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Erreur de connexion: ' + error.message);
            });
        });
    }

    // Fonction pour r√©cup√©rer les √©v√©nements
    function fetchCalendarEvents(fetchInfo, successCallback, failureCallback) {
        console.log('Fetching events...');
        
        const params = new URLSearchParams({
            start: fetchInfo.startStr,
            end: fetchInfo.endStr
        });
        
        fetch(`/api/assignments/events?${params}`)
        .then(response => {
            console.log('API Response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(events => {
            console.log('Events received:', events);
            successCallback(events);
        })
        .catch(error => {
            console.error('Error fetching events:', error);
            failureCallback(error);
            
            // Afficher un message d'erreur dans le calendrier
            const calendarEl = document.getElementById('calendar');
            if (calendarEl) {
                calendarEl.innerHTML = `
                    <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                        <h4 class="font-bold">Erreur de chargement</h4>
                        <p>Impossible de charger les √©v√©nements: ${error.message}</p>
                        <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                            R√©essayer
                        </button>
                    </div>
                `;
            }
        });
    }

    // Initialiser le calendrier
    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        
        if (!calendarEl) {
            console.error('Calendar element not found');
            return;
        }

        console.log('Initializing calendar...');

        try {
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'fr',
                firstDay: 1, // Commencer par lundi
                
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                
                buttonText: {
                    today: 'Aujourd\'hui',
                    month: 'Mois',
                    week: 'Semaine',
                    day: 'Jour'
                },
                
                height: 'auto',
                navLinks: true,
                dayMaxEvents: true,
                editable: {% if current_user.is_manager %}true{% else %}false{% endif %},
                eventStartEditable: {% if current_user.is_manager %}true{% else %}false{% endif %},
                eventDurationEditable: {% if current_user.is_manager %}true{% else %}false{% endif %},
                
                events: fetchCalendarEvents,
                
                eventClick: function(info) {
                    const event = info.event;
                    const startTime = event.start ? event.start.toLocaleString('fr-FR') : 'N/A';
                    const endTime = event.end ? event.end.toLocaleString('fr-FR') : 'N/A';
                    
                    let details = `Service: ${event.extendedProps.shift_name || 'N/A'}\n`;
                    details += `Employ√©: ${event.extendedProps.employee_name || 'N/A'}\n`;
                    details += `D√©but: ${startTime}\n`;
                    details += `Fin: ${endTime}\n`;
                    details += `Dur√©e: ${event.extendedProps.duration || 'N/A'}\n`;
                    details += `Statut: ${event.extendedProps.status_display || 'N/A'}`;
                    
                    if (event.extendedProps.notes) {
                        details += `\n\nNotes: ${event.extendedProps.notes}`;
                    }
                    
                    alert(details);
                },
                
                {% if current_user.is_manager %}
                eventDrop: function(info) {
                    updateAssignment(info.event);
                },
                
                eventResize: function(info) {
                    updateAssignment(info.event);
                },
                {% endif %}
                
                loading: function(bool) {
                    if (bool) {
                        console.log('Calendar loading...');
                    } else {
                        console.log('Calendar loaded');
                    }
                }
            });

            calendar.render();
            console.log('Calendar rendered successfully');

        } catch (error) {
            console.error('Calendar initialization error:', error);
            calendarEl.innerHTML = `
                <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700">
                    <h4 class="font-bold">Erreur d'initialisation</h4>
                    <p>Le calendrier n'a pas pu √™tre initialis√©: ${error.message}</p>
                    <button onclick="location.reload()" class="mt-2 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Recharger la page
                    </button>
                </div>
            `;
        }
    }

    {% if current_user.is_manager %}
    // Fonction pour mettre √† jour une assignation
    function updateAssignment(event) {
        const eventData = {
            start: event.start.toISOString(),
            end: event.end ? event.end.toISOString() : null
        };
        
        fetch(`/api/assignments/${event.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(eventData)
        })
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Erreur lors de la mise √† jour: ' + (data.error || 'Erreur inconnue'));
                event.revert();
            } else {
                console.log('Assignment updated successfully');
            }
        })
        .catch(error => {
            console.error('Update error:', error);
            alert('Erreur de connexion lors de la mise √† jour');
            event.revert();
        });
    }
    {% endif %}

    // D√©marrer l'initialisation
    initCalendar();

    // Exposer les fonctions globalement
    window.showQuickAddModal = showQuickAddModal;
});
</script>

<style>
/* Am√©lioration du calendrier */
.fc-event {
    border-radius: 6px !important;
    padding: 2px 4px !important;
    margin: 1px 0 !important;
    box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
}

.fc-toolbar-title {
    font-size: 1.5em !important;
    font-weight: 700 !important;
    color: #374151 !important;
}

.fc-button {
    background: #4F46E5 !important;
    border-color: #4F46E5 !important;
    font-weight: 500 !important;
}

.fc-button:hover {
    background: #4338CA !important;
    border-color: #4338CA !important;
}

.fc-col-header-cell {
    font-weight: 600 !important;
    background: #F9FAFB !important;
    color: #374151 !important;
    text-transform: uppercase !important;
    font-size: 12px !important;
    letter-spacing: 0.5px !important;
}

.fc-day-today {
    background: #EEF2FF !important;
}

/* Mode sombre pour le calendrier */
[data-theme="dark"] .fc {
    background: #1F2937 !important;
    color: #F9FAFB !important;
}

[data-theme="dark"] .fc-toolbar-title {
    color: #F9FAFB !important;
}

[data-theme="dark"] .fc-col-header-cell {
    background: #374151 !important;
    color: #E5E7EB !important;
}

[data-theme="dark"] .fc-day-today {
    background: #1E3A8A !important;
}

/* Modal en mode sombre */
[data-theme="dark"] #quickAddModal .bg-white {
    background-color: #1F2937 !important;
    color: #F3F4F6 !important;
}

[data-theme="dark"] #quickAddModal input,
[data-theme="dark"] #quickAddModal select {
    background-color: #374151 !important;
    border-color: #6B7280 !important;
    color: #F3F4F6 !important;
}

[data-theme="dark"] #quickAddModal label {
    color: #E5E7EB !important;
}
</style>

{% endblock %}

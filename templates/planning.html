{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">üìÖ Planning Maihlili PAIE</h1>
      <p class="text-gray-500">G√©rez le planning par semaine ou par mois</p>
    </div>
    <div class="flex gap-3">
      <button onclick="switchView('calendar')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 view-toggle" id="btn-calendar">
        üìÜ Calendrier
      </button>
      <button onclick="switchView('gantt')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 view-toggle" id="btn-gantt">
        üìä Vue Gantt
      </button>
    </div>
  </div>

  <div id="calendar-view" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div id="calendar" style="min-height: 600px;"></div>
  </div>

  <div id="gantt-view" class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <div class="flex justify-between items-center">
        <h3 class="text-lg font-semibold">üìä Vue Gantt - Planning hebdomadaire</h3>
        <div class="flex gap-2">
          <button onclick="previousWeek()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">‚Üê Semaine pr√©c√©dente</button>
          <span id="week-info" class="px-4 py-2 text-sm font-medium"></span>
          <button onclick="nextWeek()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">Semaine suivante ‚Üí</button>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white">
          <tr>
            <th class="text-left py-3 px-4 font-semibold w-[150px] sticky left-0 z-10 bg-blue-600">Employ√©</th>
            <th class="text-center py-3 px-4 font-semibold">Lun</th>
            <th class="text-center py-3 px-4 font-semibold">Mar</th>
            <th class="text-center py-3 px-4 font-semibold">Mer</th>
            <th class="text-center py-3 px-4 font-semibold">Jeu</th>
            <th class="text-center py-3 px-4 font-semibold">Ven</th>
            <th class="text-center py-3 px-4 font-semibold">Sam</th>
            <th class="text-center py-3 px-4 font-semibold">Dim</th>
          </tr>
        </thead>
        <tbody id="gantt-tbody" class="divide-y divide-gray-200">
          </tbody>
      </table>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Assignations cette semaine</p>
          <p class="text-2xl font-bold text-blue-600" id="stat-week">--</p>
        </div>
        <div class="text-3xl">üìÖ</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures totales</p>
          <p class="text-2xl font-bold text-green-600" id="stat-hours">--</p>
        </div>
        <div class="text-3xl">‚è∞</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employ√©s couverts</p>
          <p class="text-2xl font-bold text-purple-600" id="stat-employees">--</p>
        </div>
        <div class="text-3xl">üë•</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conformit√©</p>
          <p class="text-2xl font-bold text-orange-600" id="stat-compliance">--</p>
        </div>
        <div class="text-3xl">‚úì</div>
      </div>
    </div>
  </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
let calendar = null;
let currentWeekStart = new Date();
currentWeekStart.setDate(currentWeekStart.getDate() - currentWeekStart.getDay() + 1);
if (currentWeekStart.getDay() === 0) { // Si Dimanche (d√©calage au Lun de la semaine suivante)
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
}


// --- Fonctions de la vue Calendrier ---

// Initialiser le calendrier FullCalendar
function initCalendar() {
  const calendarEl = document.getElementById('calendar');
  
  if (calendar) {
    calendar.destroy();
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'fr',
    firstDay: 1, // Lundi
    
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    
    buttonText: {
      today: "Aujourd'hui",
      month: 'Mois',
      week: 'Semaine',
      day: 'Jour'
    },
    
    height: 'auto',
    navLinks: true,
    dayMaxEvents: true,
    editable: true,
    
    // NOUVEAU: Mettre la couleur des √©v√©nements (utilise extendedProps.color de l'API)
    eventDidMount: function(info) {
      if (info.event.extendedProps.color) {
        info.el.style.backgroundColor = info.event.extendedProps.color;
        info.el.style.borderColor = info.event.extendedProps.color;
      }
    },

    // NOUVEAU: Afficher un pop-up d√©taill√© (CORRIGEANT LES N/A)
    eventClick: function(info) {
      const props = info.event.extendedProps;
      const title = info.event.title;
      const start = new Date(info.event.start).toLocaleString('fr-FR');
      const end = new Date(info.event.end).toLocaleString('fr-FR');

      const details = `
Service: ${props.shift_name || 'N/A'}
Employ√©: ${props.employee_name || 'N/A'}
D√©but: ${start}
Fin: ${end}
Dur√©e: ${props.duration !== undefined ? props.duration + 'h' : 'N/A'}
Statut: ${props.status || 'N/A'}
      `;

      alert(title + '\n\n' + details);
    },

    events: function(info, successCallback, failureCallback) {
      fetch(`/api/assignments/events?start=${info.startStr}&end=${info.endStr}`)
        .then(response => response.json())
        .then(events => {
          successCallback(events);
          // Mettre √† jour les stats en fonction de la vue calendrier si elle est active
          if (!document.getElementById('gantt-view').classList.contains('hidden')) {
              updateStatistics(info.startStr); 
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          failureCallback(error);
        });
    }
  });
  
  calendar.render();
}


// --- Fonctions de la vue Gantt (CORRIG√âES) ---

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function loadGanttView() {
    const startIso = formatDate(currentWeekStart);
    document.getElementById('week-info').textContent = `Semaine du ${currentWeekStart.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}`;
    
    // Mettre √† jour les statistiques pour la semaine affich√©e
    updateStatistics(startIso);

    fetch(`/api/gantt-data?start=${startIso}`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.getElementById('gantt-tbody');
            tbody.innerHTML = '';
            
            const assignmentsByEmployeeAndDay = {};

            // Regrouper les assignations par employ√© et par jour
            data.assignments.forEach(a => {
                const date = a.start.substring(0, 10);
                const dayOfWeek = new Date(date).getDay();
                const employeeId = a.employee_id;
                
                if (!assignmentsByEmployeeAndDay[employeeId]) {
                    assignmentsByEmployeeAndDay[employeeId] = {};
                }
                if (!assignmentsByEmployeeAndDay[employeeId][dayOfWeek]) {
                    assignmentsByEmployeeAndDay[employeeId][dayOfWeek] = [];
                }
                
                assignmentsByEmployeeAndDay[employeeId][dayOfWeek].push(a);
            });

            // G√©n√©rer le tableau
            data.employees.forEach(employee => {
                const row = tbody.insertRow();
                row.className = 'hover:bg-gray-50';
                
                // Cellule Employ√©
                const nameCell = row.insertCell();
                nameCell.className = 'py-3 px-4 font-medium text-gray-800 sticky left-0 bg-white border-r border-gray-200';
                nameCell.textContent = employee.name;
                
                // Cellules des jours (Lundi=1 √† Dimanche=0)
                for (let i = 1; i <= 7; i++) {
                    const dayIndex = i % 7; // 1=Lun, ..., 6=Sam, 0=Dim
                    const dayCell = row.insertCell();
                    dayCell.className = 'py-2 px-1 text-center text-sm align-top';
                    
                    const assignments = assignmentsByEmployeeAndDay[employee.id] ? assignmentsByEmployeeAndDay[employee.id][dayIndex] || [] : [];
                    
                    assignments.forEach(a => {
                        const shiftDiv = document.createElement('div');
                        shiftDiv.className = 'p-1 rounded-md text-xs font-semibold my-0.5 whitespace-nowrap overflow-hidden text-ellipsis shadow-sm cursor-pointer text-white';
                        shiftDiv.style.backgroundColor = a.shift_color;
                        
                        // CORRECTION : Afficher les noms et les heures
                        shiftDiv.textContent = `${a.shift_name} (${a.start_time}-${a.end_time})`;
                        
                        // Ajouter le pop-up (alert simple pour rester coh√©rent avec le calendrier)
                        shiftDiv.onclick = function() {
                             alert(`
Assignation D√©tails:
Service: ${a.shift_name}
Employ√©: ${employee.name}
D√©but: ${new Date(a.start).toLocaleString('fr-FR')}
Fin: ${new Date(a.end).toLocaleString('fr-FR')}
`);
                        };
                        
                        dayCell.appendChild(shiftDiv);
                    });
                }
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement de la vue Gantt:', error);
            document.getElementById('gantt-tbody').innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500">Erreur lors du chargement du planning Gantt.</td></tr>';
        });
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    loadGanttView();
}

function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    loadGanttView();
}


// --- Fonctions de Contr√¥le de la Vue ---

// Changer la vue (Calendrier / Gantt)
function switchView(view) {
  const calendarView = document.getElementById('calendar-view');
  const ganttView = document.getElementById('gantt-view');
  const btnCalendar = document.getElementById('btn-calendar');
  const btnGantt = document.getElementById('btn-gantt');
  
  if (view === 'calendar') {
    calendarView.classList.remove('hidden');
    ganttView.classList.add('hidden');
    btnCalendar.classList.remove('bg-gray-200', 'text-gray-800');
    btnCalendar.classList.add('bg-blue-600', 'text-white');
    btnGantt.classList.add('bg-gray-200', 'text-gray-800');
    btnGantt.classList.remove('bg-blue-600', 'text-white');
    calendar.render(); // Redessiner le calendrier
    updateStatistics();
  } else if (view === 'gantt') {
    calendarView.classList.add('hidden');
    ganttView.classList.remove('hidden');
    btnGantt.classList.remove('bg-gray-200', 'text-gray-800');
    btnGantt.classList.add('bg-blue-600', 'text-white');
    btnCalendar.classList.add('bg-gray-200', 'text-gray-800');
    btnCalendar.classList.remove('bg-blue-600', 'text-white');
    loadGanttView();
  }
}

// Mettre √† jour les statistiques
function updateStatistics(startIso = null) {
  let url = '/api/planning-stats';
  if (startIso) {
      url += `?start=${startIso}`;
  }
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      document.getElementById('stat-week').textContent = data.assignments_week || 0;
      document.getElementById('stat-hours').textContent = (data.total_hours || 0) + 'h';
      document.getElementById('stat-employees').textContent = data.employees_covered || 0;
      document.getElementById('stat-compliance').textContent = (data.compliance || 0) + '%';
    })
    .catch(error => console.error('Erreur:', error));
}


// --- Initialisation au chargement (AFFICHER GANTT PAR D√âFAUT) ---
document.addEventListener('DOMContentLoaded', function() {
  initCalendar(); // Initialiser le calendrier (il est cach√© mais n√©cessaire pour l'objet global)
  switchView('gantt'); // Affiche le Gantt et lance loadGanttView()
});
</script>

<style>
/* Am√©liorations visuelles */
.view-toggle {
  transition: all 0.3s ease;
}

.view-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* Table Gantt optimis√©e */
#gantt-view table {
  table-layout: fixed;
  width: 100%;
}

/* Fixer la colonne Employ√© √† gauche */
#gantt-view thead th:first-child,
#gantt-view tbody td:first-child {
  z-index: 20;
}

#gantt-view tbody td:first-child {
  border-right: 1px solid #e5e7eb; /* S√©parateur */
}

/* Centrer les contenus des jours */
#gantt-view th:not(:first-child),
#gantt-view td:not(:first-child) {
  width: calc(100% / 7); /* Largeur √©gale pour les 7 jours */
  min-width: 120px;
}
</style>
{% endblock %}

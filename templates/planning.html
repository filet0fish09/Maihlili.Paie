{% extends "base.html" %}
{% block content %}
<div class="space-y-6">
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-2xl font-bold text-gray-800">📅 Planning Maihlili PAIE</h1>
      <p class="text-gray-500">Gérez le planning par semaine ou par mois</p>
    </div>
    <div class="flex gap-3">
      <button onclick="switchView('calendar')" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-lg hover:bg-gray-300 view-toggle" id="btn-calendar">
        📆 Calendrier
      </button>
      <button onclick="switchView('gantt')" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 view-toggle" id="btn-gantt">
        📊 Vue Gantt
      </button>
    </div>
  </div>

  <div id="calendar-view" class="hidden bg-white rounded-xl shadow-sm border border-gray-200 p-6">
    <div id="calendar" style="min-height: 600px;"></div>
  </div>

  <div id="gantt-view" class="bg-white rounded-xl shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200 flex justify-between items-center">
      <h3 class="text-lg font-semibold">📊 Vue Gantt - Planning hebdomadaire</h3>
      <div class="flex gap-4 items-center">
        
        <a id="export-pdf-link" 
           href="#" 
           class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center text-sm font-medium">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            Exporter PDF
        </a>

        <div class="flex gap-2">
          <button onclick="previousWeek()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">← Semaine précédente</button>
          <span id="week-info" class="px-4 py-2 text-sm font-medium"></span>
          <button onclick="nextWeek()" class="px-3 py-2 bg-gray-100 rounded-lg hover:bg-gray-200">Semaine suivante →</button>
        </div>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full gantt-table">
        <thead class="bg-gradient-to-r from-blue-600 to-blue-700 text-white sticky top-0">
          <tr>
            <th class="text-left py-3 px-4 font-semibold w-[180px] sticky left-0 z-20 bg-blue-600">Employé</th>
            <th class="text-center py-3 px-2 font-semibold">Lun</th>
            <th class="text-center py-3 px-2 font-semibold">Mar</th>
            <th class="text-center py-3 px-2 font-semibold">Mer</th>
            <th class="text-center py-3 px-2 font-semibold">Jeu</th>
            <th class="text-center py-3 px-2 font-semibold">Ven</th>
            <th class="text-center py-3 px-2 font-semibold">Sam</th>
            <th class="text-center py-3 px-2 font-semibold">Dim</th>
          </tr>
        </thead>
        <tbody id="gantt-tbody" class="divide-y divide-gray-200">
          </tbody>
      </table>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Assignations cette semaine</p>
          <p class="text-2xl font-bold text-blue-600" id="stat-week">--</p>
        </div>
        <div class="text-3xl">📅</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Heures totales</p>
          <p class="text-2xl font-bold text-green-600" id="stat-hours">--</p>
        </div>
        <div class="text-3xl">⏰</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Employés couverts</p>
          <p class="text-2xl font-bold text-purple-600" id="stat-employees">--</p>
        </div>
        <div class="text-3xl">👥</div>
      </div>
    </div>
    
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-sm text-gray-500">Conformité</p>
          <p class="text-2xl font-bold text-orange-600" id="stat-compliance">--</p>
        </div>
        <div class="text-3xl">✓</div>
      </div>
    </div>
  </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
<script>
let calendar = null;
let currentWeekStart = new Date();

// CORRECTION #2 (Décalage de date): Logique plus robuste pour trouver le lundi
function initializeWeekStart() {
    const today = new Date();
    today.setHours(0, 0, 0, 0); 
    
    // 0=Dimanche, 1=Lundi, ..., 6=Samedi
    let day = today.getDay();
    // Calcule le nombre de jours à soustraire pour revenir au Lundi (1)
    // Si c'est Dimanche (0), soustraire 6 jours pour le Lundi précédent.
    // Sinon, soustraire (day - 1).
    let dayDifference = day === 0 ? 6 : day - 1;
    
    currentWeekStart = new Date(today); // Crée une copie
    currentWeekStart.setDate(today.getDate() - dayDifference);
    currentWeekStart.setHours(0, 0, 0, 0); 
}
initializeWeekStart();


// --- Fonctions de la vue Calendrier (inchangées) ---

function initCalendar() {
  const calendarEl = document.getElementById('calendar');
  
  if (calendar) {
    calendar.destroy();
  }

  calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'fr',
    firstDay: 1, 
    
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay'
    },
    
    buttonText: {
      today: "Aujourd'hui",
      month: 'Mois',
      week: 'Semaine',
      day: 'Jour'
    },
    
    height: 'auto',
    navLinks: true,
    dayMaxEvents: true,
    editable: true,
    
    eventDidMount: function(info) {
      if (info.event.extendedProps.shift_color) {
        info.el.style.backgroundColor = info.event.extendedProps.shift_color;
        info.el.style.borderColor = info.event.extendedProps.shift_color;
      }
      if (info.event.extendedProps.shift_color && isDark(info.event.extendedProps.shift_color)) {
          info.el.style.color = 'white';
      }
    },

    eventClick: function(info) {
      const props = info.event.extendedProps;
      const start = new Date(info.event.start).toLocaleString('fr-FR');
      const end = new Date(info.event.end).toLocaleString('fr-FR');

      const durationMs = new Date(info.event.end).getTime() - new Date(info.event.start).getTime();
      const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(1);
      
      const details = `
Service: ${props.shift_name || 'N/A'}
Employé: ${props.employee_name || 'N/A'}
Début: ${start}
Fin: ${end}
Durée: ${durationHours}h
Statut: ${props.status || 'Confirmé'}
      `;

      alert('Détails de l\'assignation\n\n' + details);
    },
    
    events: function(info, successCallback, failureCallback) {
      fetch(`/api/assignments/events?start=${info.startStr}&end=${info.endStr}`)
        .then(response => response.json())
        .then(events => {
          const transformedEvents = events.map(event => ({
              ...event,
              extendedProps: {
                  ...event, 
                  shift_color: event.color,
              }
          }));
          successCallback(transformedEvents);
          if (document.getElementById('calendar-view').classList.contains('hidden') === false) {
              updateStatistics(info.startStr); 
          }
        })
        .catch(error => {
          console.error('Erreur:', error);
          failureCallback(error);
        });
    }
  });
  
  calendar.render();
}

function isDark(hex) {
    if (!hex) return false;
    const shorthandRegex = /^#?([a-f\d])([a-f\d])([a-f\d])$/i;
    hex = hex.replace(shorthandRegex, function(m, r, g, b) {
        return r + r + g + g + b + b;
    });

    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    if (!result) return false;

    const r = parseInt(result[1], 16);
    const g = parseInt(result[2], 16);
    const b = parseInt(result[3], 16);

    return (0.2126 * r + 0.7152 * g + 0.0722 * b) < 140; 
}

// --- Fonctions de la vue Gantt ---

function formatDate(date) {
    // Format YYYY-MM-DD
    return date.toISOString().split('T')[0];
}

function loadGanttView() {
    const startIso = formatDate(currentWeekStart);
    document.getElementById('week-info').textContent = `Semaine du ${currentWeekStart.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit' })}`;
    
    const exportLink = document.getElementById('export-pdf-link');
    if (exportLink) {
        exportLink.href = `/api/export-gantt-pdf?start=${startIso}`;
    }
    
    updateStatistics(startIso);

    fetch(`/api/gantt-data?start=${startIso}`)
        .then(response => {
            if (!response.ok) {
                throw new Error(`Erreur HTTP: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            renderGantt(data);
        })
        .catch(error => {
            console.error('Erreur lors du chargement de la vue Gantt:', error);
            document.getElementById('gantt-tbody').innerHTML = '<tr><td colspan="9" class="text-center py-4 text-red-500">Erreur lors du chargement du planning Gantt. Vérifiez votre console et votre backend Flask (/api/gantt-data).</td></tr>';
        });
}

function renderGantt(data) {
    const tbody = document.getElementById('gantt-tbody');
    tbody.innerHTML = '';
    
    const assignmentsByEmployeeAndDay = {};

    data.assignments.forEach(a => {
        if (typeof a.start !== 'string') {
             console.error("Erreur de données: a.start n'est pas une chaîne. Vérifiez votre backend Flask.");
             return;
        }
        
        const date = a.start.substring(0, 10); 
        const dayOfWeek = new Date(date).getDay(); 
        const employeeId = a.employee_id;
        
        if (!assignmentsByEmployeeAndDay[employeeId]) {
            assignmentsByEmployeeAndDay[employeeId] = {};
        }
        if (!assignmentsByEmployeeAndDay[employeeId][dayOfWeek]) {
            assignmentsByEmployeeAndDay[employeeId][dayOfWeek] = [];
        }
        
        assignmentsByEmployeeAndDay[employeeId][dayOfWeek].push(a);
    });

    const weekStartDate = new Date(currentWeekStart);

    data.employees.forEach(employee => {
        const row = tbody.insertRow();
        row.className = 'hover:bg-gray-50';
        
        // Cellule Employé (Sticky)
        const nameCell = row.insertCell();
        nameCell.className = 'py-2 px-4 font-medium text-gray-800 sticky left-0 z-10 bg-white border-r border-gray-200 text-sm';
        nameCell.textContent = employee.name;
        
        // Cellules des jours (Lundi=1 à Dimanche=0)
        for (let i = 1; i <= 7; i++) {
            const dayIndex = i % 7; 
            const dayCell = row.insertCell();
            
            // --- Préparation de la destination D&D ---
            const cellDate = new Date(weekStartDate);
            cellDate.setDate(weekStartDate.getDate() + (i - 1));
            const cellDateIso = formatDate(cellDate);
            
            dayCell.className = 'py-2 px-1 text-center text-sm align-top gantt-cell drag-drop-target';
            dayCell.setAttribute('data-employee-id', employee.id);
            dayCell.setAttribute('data-date', cellDateIso);
            // -------------------------------------------
            
            const assignments = assignmentsByEmployeeAndDay[employee.id] ? assignmentsByEmployeeAndDay[employee.id][dayIndex] || [] : [];
            
            assignments.forEach(a => {
                const shiftDiv = document.createElement('div');
                
                // --- Préparation de la source D&D ---
                shiftDiv.className = 'p-1 rounded text-sm font-semibold my-1 whitespace-nowrap overflow-hidden text-ellipsis shadow-md cursor-pointer gantt-shift-block-large';
                shiftDiv.setAttribute('draggable', 'true');
                shiftDiv.setAttribute('data-assignment-id', a.id);
                // ---------------------------------------

                shiftDiv.style.backgroundColor = a.shift_color;
                
                if (isDark(a.shift_color)) {
                    shiftDiv.style.color = 'white';
                } else {
                    shiftDiv.style.color = '#333';
                }

                shiftDiv.innerHTML = `
                    <div class="truncate leading-tight">${a.shift_name}</div>
                    <div class="font-normal leading-tight text-opacity-90 text-xs">${a.start_time}-${a.end_time}</div>
                `;
                
                shiftDiv.onclick = function(event) {
                    event.stopPropagation(); 
                    const start = new Date(a.start).toLocaleString('fr-FR');
                    const end = new Date(a.end).toLocaleString('fr-FR');
                    const durationMs = new Date(a.end).getTime() - new Date(a.start).getTime();
                    const durationHours = (durationMs / (1000 * 60 * 60)).toFixed(1);

                    alert(`
Assignation Détails:
Service: ${a.shift_name}
Employé: ${employee.name}
Début: ${start}
Fin: ${end}
Durée: ${durationHours}h
                    `);
                };
                
                dayCell.appendChild(shiftDiv);
            });
        }
    });
}

function nextWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() + 7);
    loadGanttView();
}

function previousWeek() {
    currentWeekStart.setDate(currentWeekStart.getDate() - 7);
    loadGanttView();
}


// --- Fonctions de Contrôle de la Vue ---

function switchView(view) {
  const calendarView = document.getElementById('calendar-view');
  const ganttView = document.getElementById('gantt-view');
  const btnCalendar = document.getElementById('btn-calendar');
  const btnGantt = document.getElementById('btn-gantt');
  
  if (view === 'calendar') {
    calendarView.classList.remove('hidden');
    ganttView.classList.add('hidden');
    btnCalendar.classList.remove('bg-gray-200', 'text-gray-800');
    btnCalendar.classList.add('bg-blue-600', 'text-white');
    btnGantt.classList.add('bg-gray-200', 'text-gray-800');
    btnGantt.classList.remove('bg-blue-600', 'text-white');
    calendar.render(); 
    updateStatistics();
  } else if (view === 'gantt') {
    calendarView.classList.add('hidden');
    ganttView.classList.remove('hidden');
    btnGantt.classList.remove('bg-gray-200', 'text-gray-800');
    btnGantt.classList.add('bg-blue-600', 'text-white');
    btnCalendar.classList.add('bg-gray-200', 'text-gray-800');
    btnCalendar.classList.remove('bg-blue-600', 'text-white');
    loadGanttView();
  }
}

function updateStatistics(startIso = null) {
  let url = '/api/planning-stats';
  
  fetch(url)
    .then(response => response.json())
    .then(data => {
      document.getElementById('stat-week').textContent = data.assignments_week || 0;
      document.getElementById('stat-hours').textContent = (data.total_hours || 0) + 'h';
      document.getElementById('stat-employees').textContent = data.employees_covered || 0;
      document.getElementById('stat-compliance').textContent = (data.compliance || 0) + '%';
    })
    .catch(error => console.error('Erreur:', error));
}


// ====================================================================
// --- GESTION DU GLISSER-DÉPOSER (DRAG & DROP) ---
// ====================================================================

let draggedAssignmentId = null;

document.addEventListener('dragstart', function(event) {
    // Le drag doit se lancer sur le shift block
    const shiftBlock = event.target.closest('.gantt-shift-block-large');
    if (shiftBlock && shiftBlock.getAttribute('draggable') === 'true') {
        draggedAssignmentId = shiftBlock.dataset.assignmentId;
        event.dataTransfer.setData('text/plain', draggedAssignmentId);
        shiftBlock.classList.add('is-dragging'); 
        
        // CORRECTION #1 (D&D): Ajout temporaire de l'effet "pointer-events: none" 
        // LORS du drag pour que la cible soit la cellule <td> sous-jacente.
        // C'est un meilleur compromis que de le mettre globalement dans le CSS.
        event.dataTransfer.setDragImage(shiftBlock, shiftBlock.offsetWidth / 2, shiftBlock.offsetHeight / 2);

        document.querySelectorAll('.gantt-shift-block-large').forEach(el => el.style.pointerEvents = 'none');
    }
});

document.addEventListener('dragend', function(event) {
    const shiftBlock = event.target.closest('.gantt-shift-block-large');
    if (shiftBlock) {
        shiftBlock.classList.remove('is-dragging');
    }
    
    // CORRECTION #1 (D&D): Réactiver pointer-events après la fin du drag
    document.querySelectorAll('.gantt-shift-block-large').forEach(el => el.style.pointerEvents = 'auto');
    
    document.querySelectorAll('.drag-drop-target').forEach(cell => cell.classList.remove('drag-over'));
    draggedAssignmentId = null;
});

document.addEventListener('dragover', function(event) {
    const targetCell = event.target.closest('.drag-drop-target');
    if (targetCell) {
        event.preventDefault(); // ESSENTIEL
        targetCell.classList.add('drag-over'); 
    }
});

document.addEventListener('dragleave', function(event) {
    const targetCell = event.target.closest('.drag-drop-target');
    if (targetCell) {
        targetCell.classList.remove('drag-over');
    }
});

document.addEventListener('drop', function(event) {
    event.preventDefault();
    
    // La cible est maintenant garantie d'être la <td> grâce au pointer-events:none temporaire
    const targetCell = event.target.closest('.drag-drop-target'); 
    
    document.querySelectorAll('.drag-drop-target').forEach(cell => cell.classList.remove('drag-over'));
    
    if (targetCell && draggedAssignmentId) {
        const newEmployeeId = targetCell.dataset.employeeId;
        const newDate = targetCell.dataset.date;
        
        if (!newEmployeeId || !newDate) {
             alert("Informations de destination manquantes (Employé ou Date).");
             return;
        }

        // 1. Envoyer la requête au Backend pour la mise à jour
        fetch('/api/assignment/move', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                assignment_id: draggedAssignmentId,
                new_employee_id: newEmployeeId,
                new_date: newDate
            })
        })
        .then(response => {
             if (!response.ok) {
                return response.json().then(err => { throw new Error(err.error || 'Erreur inconnue côté serveur'); });
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                // 2. Recharger les données du planning
                loadGanttView(); 
            } else {
                alert('Erreur lors du déplacement : ' + (data.error || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur réseau/serveur:', error);
            alert('Erreur lors du déplacement du shift : ' + error.message);
        })
        .finally(() => {
            draggedAssignmentId = null;
        });
    }
});

// --- Initialisation au chargement (AFFICHER GANTT PAR DÉFAUT) ---
document.addEventListener('DOMContentLoaded', function() {
  initCalendar(); 
  switchView('gantt'); 
});
</script>

<style>
/* --- Styles de la vue Gantt (Mise à jour pour le fix D&D) --- */

.view-toggle {
  transition: all 0.3s ease;
}

.view-toggle:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.gantt-table {
  table-layout: fixed;
  width: 100%;
  border-collapse: separate;
  border-spacing: 0;
}

.gantt-table tbody td {
  padding-top: 8px !important; 
  padding-bottom: 8px !important;
  vertical-align: top;
}

/* FIX D&D : Suppression du pointer-events: none; ici pour permettre le dragstart */
.gantt-shift-block-large {
    padding: 4px 6px !important; 
    line-height: 1.3;
    font-size: 0.8rem; 
    letter-spacing: 0.01em;
    opacity: 0.98;
    transition: all 0.1s ease;
    
    /* REMOVED: pointer-events: none; */
    pointer-events: auto; /* Laisser par défaut (auto) pour que dragstart fonctionne */
}

.gantt-shift-block-large:hover {
    opacity: 1;
    transform: scale(1.02);
    box-shadow: 0 3px 10px rgba(0,0,0,0.25);
    z-index: 10;
}

/* Style de glissement */
.gantt-shift-block-large.is-dragging {
    opacity: 0.4;
    border: 2px dashed #3B82F6;
    box-shadow: none;
    cursor: grabbing !important;
    /* On laisse pointer-events: auto pour éviter les interférences */
}


/* Styles de la table (Sticky Columns, etc.) */
.gantt-table thead th:first-child,
.gantt-table tbody td:first-child {
  z-index: 20; 
  position: sticky;
  left: 0;
  background-color: white; 
}

.gantt-table thead th:first-child {
    background-color: #2563EB; 
}

.gantt-table tbody td:first-child {
  border-right: 1px solid #e5e7eb; 
}

.gantt-table th:not(:first-child),
.gantt-table td:not(:first-child) {
  width: calc((100% - 180px) / 7); 
  min-width: 150px; 
  max-width: 180px;
}

/* Feedback pour le Glisser-Déposer */
.drag-drop-target.drag-over {
    background-color: #EBF8FF !important; 
    box-shadow: inset 0 0 0 2px #3B82F6;
    transition: background-color 0.1s;
}

</style>
{% endblock %}
